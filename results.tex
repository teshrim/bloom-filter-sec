\section{Achieving Security Notions}

\subsection{A Meta-Theorem for Privacy}
Here we prove a result that can be used to show that a large class of ``canonical''
data structures are semantically secure, with respect to leakage of the size of the set.
\jnote{It would not be too hard to generalize this to arbitrary data structures over
arbitrary objects, so long as the number of distinct queries to the PRF made by $\Rep$
depends only on ${\sf leak}$.}

We first define what we mean by ``canonical.''

\def\bool{\{0,1\}}

\begin{definition}
A set-multiplicity data structure $(\Rep, \Qry)$ is {\sf canonical} if
there exist algorithms $\Rep_1, \Rep_2$, and a function
$F: \bool^n \times \bool^{\ell_{in}} \rightarrow \bool^{\ell_{out}}$
such that the following hold:
\begin{itemize}
\item $\Rep_1$ takes as input a set $S$ and outputs distinct values $x_1, \ldots, x_t \in \bool^{\ell_{in}}$,
where $t$ depends only on~$|S|$.
\item $\Rep_2$ takes as input $|S|$ and $y_1, \ldots, y_t \in \bool^{\ell_{out}}$, and outputs
$\pubaux$.
\item For any $S$, the distribution on $\pubaux$ output by $\Rep(S)$ is identical to the distribution
on $\pubaux$ computing as follows:
\begin{enumerate}
\item $x_1, \ldots, x_t \getsr \Rep_1(S)$.
\item $k \getsr \bool^n$.
\item $\pubaux \getsr \Rep_2(|S|, F_k(x_1), \ldots, F_k(x_t))$.
\end{enumerate}
\end{itemize}
In this case, we say that $(\Rep_1, \Rep_2, F)$ is the {\sf canonical representation}
of~$\Rep$.
\end{definition}
\jnote{Not sure how general to make the above. Need to verify that it is general enough
to prove security of all the constructions we care about.}

We next show that any canonical data structure in which $F$ is a pseudorandom function is
semantically secure with respect to leakage consisting of the size of the set.

\begin{theorem}
Let $\Pi=(\Rep, \Qry)$ be a canonical set-multiplicity data structure for which $\Rep$ has canonical representation
$(\Rep_1, \Rep_2, F)$. If $F$ is a $(t, \epsilon)$-pseudorandom function, then $\Pi$
is semantically secure with respect to leakage function ${\sf leak}(S) = |S|$.
\end{theorem}
\begin{proof}
We define the following simulator $\Sim$: on input $n$, define $S^*=\{e_1, \ldots, e_n\}$
(for distinct elements $e_1, \ldots, e_n$). Then compute
\begin{enumerate}
\item $x_1, \ldots, x_t \getsr \Rep_1(S^*)$,
\item $k \getsr \bool^n$,
\item $\pubaux \getsr \Rep_2(|S|, F_k(x_1), \ldots, F_k(x_t))$,
\end{enumerate}
and output $\pubaux$.

\def\hyb{\mbox{{\sc Hyb}}}

For a given set $S$, define distribution $\mbox{{\sc Real}}_S$ as
\[ \{ (\pubaux, \privaux) \getsr \Rep(S) : \pubaux\},\]
and define distribution $\mbox{{\sf Ideal}}_S$ as
\[ \{ \pubaux \getsr \Sim(|S|) : \pubaux \}.\]
Our goal is to show that $\mbox{{\sc Real}}_S$ and $\mbox{{\sf Ideal}}_S$ are computationally
indistinguishable for any set~$S$. \jnote{I'm not quite sure how to elegantly do a proof
like this in the concrete setting.}
To do so, first note that we can express $\mbox{{\sc Real}}_S$ as the outcome of
the following experiment:
\begin{enumerate}
\item $x_1, \ldots, x_t \getsr \Rep_1(S)$.
\item $k \getsr \bool^n$.
\item $\pubaux \getsr \Rep_2(|S|, F_k(x_1), \ldots, F_k(x_t))$.
\item Return $\pubaux$.
\end{enumerate}

Now, consider a hybrid distribution $\hyb_S$ computed as follows:
\begin{enumerate}
\item $x_1, \ldots, x_t \getsr \Rep_1(S)$.
\item $y_1, \ldots, y_t \leftarrow \bool^{\ell_{out}}$
\item $\pubaux \getsr \Rep_2(|S|, y_1, \ldots, y_t)$.
\item Return $\pubaux$.
\end{enumerate}
It follows immediately from the fact that $F$ is a pseudorandom function (and efficiency
of $\Rep_2$) that $\hyb_S$ is computationally indistinguishable from $\mbox{{\sc Real}}_S$.

Next, consider the following distribution $\hyb'_S$:
\begin{enumerate}
\item $S^* := \{e_1, \ldots, e_n\}$, where $n = |S|$.
\item $x_1, \ldots, x_{t^*} \getsr \Rep_1(S^*)$.
\item $y_1, \ldots, y_{t^*} \leftarrow \bool^{\ell_{out}}$
\item $\pubaux \getsr \Rep_2(|S|, y_1, \ldots, y_{t^*})$.
\item Return $\pubaux$.
\end{enumerate}
We claim that $\hyb'_S$ is identically distributed to $\hyb_S$. The follows immediately from the
observation that the distribution on $t$ (in $\hyb_S$) is identical to the distribution on~$t^*$
(in $\hyb'_S$) by definition
of what it means to be canonical.

To complete the proof, we simply note that $\hyb'_S$ and $\mbox{{\sf Ideal}}_S$
are computationally indistinguishable, again relying on pseudorandomness of~$F$.
\end{proof}

%Here is a proof sketch:
%The simulator, given n=|S|, runs the honest scheme on inputs x_1, ...,
%x_n and outputs the public portion of the result.
%
%To see that this is indistinguishable from the real public portion on
%the actual set S, consider the following hybrids:
%H0: The real pub produced from the real set S={s_1, ..., s_n}
%H1: Run the representation algorithm on S, but using random functions
%in place of PRFs, and output pub.
%H2: Run the representation algorithm on {x_1, ..., x_n}, still using
%random functions in place of PRFs, and output pub. The claim is that
%this is identically distributed to H1. The main observation is that
%since we are using random functions, the inputs to the random
%functions don't matter, subject to the technical condition that the
%number of distinct inputs to the random functions does not change.
%(Here is where we rely on the fact that |S|=n is known, as well as an
%appropriate definition of "natural.")
%H3: Run the representation algorithm on {x_1, ..., x_n}, using the
%real Rep (with PRFs).

\jnote{Organize by scheme, not by security notions.}

\include{scheme-descriptions}


%%%%%%%%%%%%%%%%% LINEAR-PRF %%%%%%%%%%%%%%%%%%%%

\heading{Linear-PRF construction. }
Here we consider a set-multiplicity data structure that was attacked by Neidermayer et al. in~\cite{xxx}. Fix $n,k,m \geq 0$ and let $\mathcal{S}=[\univ]^n$.  Then $\Pi_{\mathrm{lin}}= (\calQ,\Rep, \Qry)$ is defined as in Figure~\ref{fig:lin-and-ds} (left side).  The following result shows, informally, that if~$F$ is a good PRF, then $\Pi_\mathrm{lin}$ is correct against adaptive error-finding adversaries.

\begin{theorem}\label{thm1}\label{thm:lin-correctness}
Fix $k,m,n,r>0$, and let $\Pi_{\mathrm{lin}}= (\calQ,\Rep, \Qry)$ be the set-multiplicity data structure described in Figure~\ref{fig:lin-and-ds}. Let $\distr{}{}$ be a distribution over~$\mathcal{S}$.  For any adversary~$A$ that makes a total of~$q$ queries to its oracle and has time-complexity~$O(t)$, there exist prf-adversaries~$B_1,B_2$ (explicitly constructed in the proof of this theorem) such that
\[
\AdvCorrect{\Pi_{\mathrm{lin}},\distr{}{},r}{A} \leq  \AdvPRF{F}{B_1} + \AdvPRF{F}{B_2}  +{\dbinom{q}{r}} \left( (1-e^{-kn/m})^k + O(1/n) \right)^r\,.
\]
Here, $B_1$ and $B_2$, each ask~$q$ oracle queries and have time complexity~$O(t+qm)$.
\end{theorem}
The proof appears in Appendix~\ref{app:xxx}.  We note that Kirsch and Mitzenmacher~\cite{xxx} show
that the ($r=1$, zero-query) FP-probability for~$\Pi_\mathrm{lin}$ is
always within $O(1/n)$ of $(1-e^{-kn/m})^k$, although the asymptotic
rate of convergence is faster than~$1/n$.  The factor of $\dbinom{q}{r}$ arises as a result
of moving from the adaptive to the zero-query setting.  Finally, $\dbinom{q}{r} \leq q^r$ (with
reasonable tightness when~$r$ is small) in which case the final term in the bound behaves as
$(q (1-e^{-kn/m})^k + O(q/n) )^r$; loosely, the bound one expects for
trying to find a single FP in each of~$r$ independent``rounds'', each round
consisting of~$q$ attempts.

\begin{theorem}\label{thm:lin-ss}
Fix $k,m,n>0$, and let $\Pi_{\mathrm{ds}}= (\calQ,\Rep, \Qry)$ be the set-multiplicity data structure described in Figure~\ref{fig:lin-and-ds}.  For any set~$S$, let $\leak(S)=|S|$.  There exists a simulator~$\Sim$ such that, for any adversary~$A$
\[
\AdvPrivSS{\Pi_{\mathrm{ds}},\leak}{A,\Sim} \leq  \AdvPRF{F}{B} + \mbox{[TBD]}
\]
where~$B$ is constructed from~$A$.  (Both~$B$ and~$\Sim$ are explicitly constructed in the proof of this theorem.)
\end{theorem}
\begin{proof}[Proof (sketch). ]
\end{proof}

%%%%%%%%%%%%%%%%% DOMAIN-SEPARATED PRF %%%%%%%%%%%%%%%%%%%%

\heading{Construction of PRF with domain separation.}
Let $\Pi_{\mathrm{ds}}= (\calQ,\Rep, \Qry)$ be a set-multiplicity data structure defined on the right-side of Figure~\ref{fig:lin-and-ds}.  As with the preceding theorem, the following says (informally) that if~$F$ is a secure PRF, then this domain-separated PRF construction is correct against adaptive adversaries.  We note that Neidermayer et al. in~\cite{xxx} suggest replacing the linear-PRF hash functions in the previous construction with independently keyed PRFs as a way to thwart their attacks.  The construction we consider now achieves the same end, albeit via explict domain separation rather than separate keys.


\begin{theorem}\label{thm2}\label{thm:ds-correctness}
Fix $k,m,n,r>0$, and let $\Pi_{\mathrm{ds}}= (\calQ,\Rep, \Qry)$ be the set-multiplicity data structure in Figure~\ref{fig:lin-and-ds}. Let $\distr{}{}$ be a distribution over~$\mathcal{S}$.  For any adversary~$A$ that makes a total of~$q$ queries to its oracle and has time-complexity~$O(t)$, there exists a prf-adversary ~$B$ (explicitly constructed in the proof of this theorem) such that
\[
\AdvCorrect{\Pi_{\mathrm{ds}},\distr{}{},r}{A} \leq  \AdvPRF{F}{B}  + {\dbinom{q}{r}} \left( (1-e^{-kn/m})^k + O(1/n) \right)^r\,.
\]
Here, $B$ asks $q$ queries, and has time complexity $O(t+qm)$.
\end{theorem}

%%%%%%%%%%
\begin{theorem}\label{thm:ds-ss}
Fix $k,m,n>0$, and let $\Pi_{\mathrm{ds}}= (\calQ,\Rep, \Qry)$ be the set-multiplicity data structure described in Figure~\ref{fig:lin-and-ds}.  For any set~$S$, let $\leak(S)=|S|$.  There exists a simulator~$\Sim$ such that, for any adversary~$A$
\[
\AdvPrivSS{\Pi_{\mathrm{ds}},\leak}{A,\Sim} \leq  \AdvPRF{F}{B}
\]
where~$B$ is constructed from~$A$.  (Both~$B$ and~$\Sim$ are explicitly constructed in the proof of this theorem.)
\end{theorem}
\begin{proof}[Proof (sketch). ]
Adversary~$B^{f}$ simulates the steps of $\ExpPrivSSreal{\Pi_{\mathrm{ds}}}{A}$, using its oracle to simuate~$\Rep(S)$.  When~$f=F_K$ then the simulation is perfect.  When~$f=\rho$ then~$B$ simulates $\ExpPrivSSreal{\overline{\Pi}_{\mathrm{ds}}}{A}$ where $\overline{\Rep}$ effectively uses~$k$ independent random functions as the hash functions.  But the $\pub$ produced by $\overline{\Rep}$ has a distribution that depends only~$|S|=n$, not the specific elements of~$S$, and the other public parameters~$m,k$.  Thus, a simulator~$\Sim$ given only $\leak(S)=|S|$ can produce a correct~$\pub$ as follows: starting with an all-zeros array~$M$ of length~$m$, uniformly sample (with replacement)~$nk$ integers in~$[m]$ and set the resulting positions of~$M$ to 1.
\end{proof}
%%%%%%%%%%

%%%%%%%%%%%%%%%%% CLASSICAL BLOOM FILTER IN ROM %%%%%%%%%%%%%%%%%%%%

\heading{Classical Bloom filter in random oracle model (ROM). }
Fix $n,k,m \geq 0$ and let $\mathcal{S}=[\univ]^n$.  Then $\Pi_{\mathrm{Bloom}}= (\calQ,\Rep, \Qry)$ is defined as in Figure~\ref{fig:bf-and-garbled-bf} (left side).  The following result shows,

\begin{theorem}\label{thm3}\label{thm:bf-correctness}
Fix $k,m,n,r>0$, and let $\Pi_{\mathrm{Bloom}}= (\calQ,\Rep, \Qry)$ be the set-multiplicity data structure just described. For any adversary~$A$ that makes a total of~$q_T$ queries to the $\Test$ oracle, and $q_R$ queries to the RO, and has time-complexity~$O(t)$,
\[
\AdvCorrect{\Pi_{\mathrm{Bloom}},\distr{\calS}{},r}{A} \leq  {\dbinom{q_T + q_H}{r}} \left( (1-e^{-kn/m})^k + O(1/n) \right)^r\,.
\]
\end{theorem}

\input{Theorem3_FP}

\todo{Below are two lists of things that we should show.}

\heading{Correctness. }  Here we give security proofs and attacks with respect to the correctness notions.
\begin{itemize}
\item Show Bloom Filter is correct in the ROM. \jnote{Should follow along the lines
of Theorem~2, but taking into account adversary's oracle queries.}
\item correctness security/attacks on the bigram/PRF-based double-hashing construction ($h_j(x) = F_{K1}(x) + j\cdot F_{K2}(x) \bmod m$ where the~$x$ are bigrams of names, etc.)
\jnote{Done}
\item correctness-security/attacks on the bigram/domain-separated PRF construction ($h_j(x)=F_K(\langle j,x \rangle) \bmod m$, or just assume range of~$F$ is $[m]$.) \jnote{Done}
\item correctness-security/attacks Dong, Chen, Wen ``garbled Bloom filter'' construction

\end{itemize}

\heading{Privacy. } Here we give security proofs and attacks with respect to the privacy notions we have defined.
\tsnote{Under our current notions, you can never hope to prove privacy bounds that beat the element wise min-entropy of $\distr{}{}$.}
\begin{itemize}
\item Prove that the basic BF, in the ROM, is private.  \tsnote{Relative the strongest notion for which this is true.  If it isn't true for all, then give the attack(s).}

\item As a simple corrolary, show that the basic BF with $h_j(x)=F_K(\langle j,x \rangle)$ is private.  \tsnote{I believe this also shows that the bigram/PRF approach examined by Neidermayer et al.\ is secure when the hash functions are the $h_j(x)$ just described.  This was, in fact, one of the countermeasures they proposed. }

\item Prove privacy bounds for the constructions from NY. \jnote{Is this interesting?}

\item Cast Neidermayer et al.\ attacks on the bigram/PRF-based double-hashing construction (see their paper) into our formalism.  \tsnote{Note that their attack would allow one to recover \emph{every} name, not just one.}

\item Prove a privacy bound for the bigram/PRF-based double-hashing construction that Neidermayer et al.\ attacks. I expect that the provable security bound is considerably worse than the min-entropy because of the way the representation is made.  (Essentially, the Hamming weight of the representation is a good estimate of the length of the longest surname in filter.)
\jnote{Maybe tailor leakage function appropriately, i.e., so that
it only leaks the number of bigrams?}

\item Attack priv-security of Dong, Chen, Wen ``garbled Bloom Filter'' construction when the hash functions are public.\tsnote{I give the attack in the related work section.  Copy it here and flesh it out.}  Prove priv-security privacy of construction when hash functions are secret.  \tsnote{Makes the point that the application setting really matters.}

\item Prove privacy bounds of other suggestions, such as the record-level BF from Durham et al.?  This would be a nice pairing with the Neidermayer et al.\ results

\item ...
\end{itemize}
